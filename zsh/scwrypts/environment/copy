#!/bin/zsh               
DEPENDENCIES+=()
REQUIRED_ENV+=()

use scwrypts/environment-files

CHECK_ENVIRONMENT
#####################################################################

PROMPT 'choose an environment to copy'
TEMPLATE_ENV_NAME=$(SCWRYPTS__SELECT_ENV)
[ ! $TEMPLATE_ENV_NAME ] && ABORT

STATUS "selected '$TEMPLATE_ENV_NAME'"

PROMPT 'enter new environment name'
ENV_NAME=$(echo '' | FZF_HEAD 'new environment')
[ ! $ENV_NAME ] && ABORT

TEMPLATE_ENV_FILE=$(SCWRYPTS__GET_ENV_FILE $TEMPLATE_ENV_NAME 2>/dev/null)
ENV_FILE=$(SCWRYPTS__GET_ENV_FILE $ENV_NAME)

[ -f "$ENV_FILE" ] && FAIL 2 "'$ENV_NAME' already exists"

STATUS "creating environment '$ENV_NAME'"
cat "$TEMPLATE_ENV_FILE" \
	| sed 's/ from.*//' \
	> "$ENV_FILE" \
	&& SCWRYPTS__RUN --name scwrypts/environment/synchronize --group scwrypts --type zsh -- --no-prompt \
	&& SUCCESS "created '$ENV_NAME'" \
	|| FAIL 3 "something went wrong creating '$ENV_NAME'"

SUCCESS "finished copy environment '$TEMPLATE_ENV_NAME > $ENV_NAME'"
